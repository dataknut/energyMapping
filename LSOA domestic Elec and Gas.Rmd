---
title: "LSOA domestic Electricty and Gas maps"
author: "Meghan Kinglsey-Walsh"
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: TRUE
  bookdown::pdf_document2:
    toc: yes
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2: 
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
    fig_width: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # set this to FALSE if you don't want the code in the final output

# useful R libraries
library(ggplot2)
library(readr)
library(dplyr)

# GIS libraries
library(raster)
library(sf)
library(spData)
library(spDataLarge)

dataFolder<-"/Users/megha/Desktop/1. Uni/Masters/Project/Mapping Code/data/" # default for Meghan
user <- Sys.info()[[7]] # who are we logged in as?
if(user == "ben"){
  dataFolder <- path.expand("~/University of Southampton/HCC Energy Landscape Mapping project - Documents/General/data/")
}

# this will not print anything out when knitted due to the include=FALSE setting in the chunk header
message("User: ", user)
message("dataFolder: ", dataFolder)
```


# Mapping the Lower Layer Super Output Area (LSOA)
## Mapping Domestic
### Mapping Electricity consumption
####2019
```{r Loading in the LSOA electricty consumption data}
#Electricty consumption data LSOA pre downloaded
inFile <-paste0(dataFolder, "energy/electricity/LSOA Dom Elec csv/LSOA_ELEC_2019.csv")
lsoa_elecData <- readr::read_csv(inFile)
lsoa_elecData$LSOA11CD <- lsoa_elecData$`Lower Layer Super Output Area (LSOA) Code`
head(lsoa_elecData)
```

```{r Loading in boundary data for the LSOA}
#The LSOA boundaries for the Solent have been pre-downloaded
inf<-paste0(dataFolder, "boundaries/LSOA/lsoa_solent.shp")
message ("Loading LSOA boundaries from file")
lsoa_sf_data <- sf::read_sf(inf)
head(lsoa_sf_data)
table(lsoa_sf_data$LAD11NM)#How many LSOAs are there in each LA
```

```{r Mapping the electricty consumption of the LSOAs}
lsoa_merged_sf <- merge(lsoa_sf_data, lsoa_elecData) #merging the boundaries and energy data
ggplot2::ggplot(lsoa_merged_sf) + 
  geom_sf(aes(fill = `Mean domestic electricity consumption \n(kWh per meter)`)) +
  scale_fill_continuous(name = "Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Solent (all LSOAs)")
#Mapping it
```
####Map with Overlay
```{r Check leaflet for dom electricity consumption}
library(leaflet)

st_coord_sys <- st_crs(lsoa_merged_sf)
st_coord_sys$epsg

#Trasforming the coord systen
if(st_coord_sys$epsg !=4326){
map_df_trans <- st_transform(lsoa_merged_sf, "+proj=longlat +datum=WGS84")
}
```
```{r Plotting leaflet dom electricity consumption map}
qpal <- colorNumeric("Reds", map_df_trans$`Mean domestic electricity consumption \n(kWh per meter)`, n=9)

leaflet(map_df_trans) %>%
addTiles() %>%  # Add default OpenStreetMap map tiles
  addPolygons(color = ~qpal(`Mean domestic electricity consumption \n(kWh per meter)`),
              fillOpacity = 0.6, weight = 1.5, popup = ~(LSOA11CD), 
             
  
               highlight = highlightOptions(
                weight = 5,
                color = "#666",
                fillOpacity = 0.7,
                bringToFront = TRUE))


```
##### Looking at cities in more detail        
```{r Southampton LSOA dom Elec}
#Cities such as Southampton disappear due to their density, we will now map Southampton alone to see this area in more detail
mapData <- dplyr::filter(lsoa_merged_sf, LAD11NM == "Southampton")
# plotting the electricity consumption of Southampton in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = `Mean domestic electricity consumption \n(kWh per meter)`)) +
  scale_fill_continuous(name = "Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Southampton")
```
```{r Portsmouth LSOA dom Elec}
#Cities such as Portsmouth disappear due to their density, we will now map Portsmouth alone to see this area in more detail
mapData <- dplyr::filter(lsoa_merged_sf, LAD11NM == "Portsmouth")
# plotting the electricity consumption of Portsmouth in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = `Mean domestic electricity consumption \n(kWh per meter)`)) +
  scale_fill_continuous(name = "Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Portsmouth")
```
```{r Winchester LSOA dom Elec}
#Cities such as Winchester disappear due to their density, we will now map Winchester alone to see this area in more detail
mapData <- dplyr::filter(lsoa_merged_sf, LAD11NM == "Winchester")

# plotting the electricity consumption of Winchester in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = `Mean domestic electricity consumption \n(kWh per meter)`)) +
  scale_fill_continuous(name = "Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Winchester")
```
####Difference between 2010 and 2019 dom elec
```{r Creating the difference in LSOA mean dom elec consumption variable}
domelec_LSOA_2010 <- readr::read_csv(paste0(dataFolder,"energy/electricity/LSOA Dom Elec csv/LSOA_ELEC_2010.csv"))
domelec_LSOA_2019 <- readr::read_csv(paste0(dataFolder, "energy/electricity/LSOA Dom Elec csv/LSOA_ELEC_2019.csv"))
domelec_LSOA_2010$de2010 <- domelec_LSOA_2010$'Mean domestic electricity consumption \n(kWh per meter)'
domelec_LSOA_2019$de2019 <- domelec_LSOA_2019$'Mean domestic electricity consumption \n(kWh per meter)'
# create unambiguous lsoa code for matching to each other and the sf geometry
domelec_LSOA_2010$LSOA11CD <- domelec_LSOA_2010$`Lower Layer Super Output Area (LSOA) Code`
domelec_LSOA_2019$LSOA11CD <- domelec_LSOA_2019$`Lower Layer Super Output Area (LSOA) Code`
  
merged_de <- merge(domelec_LSOA_2010, domelec_LSOA_2019, by="Lower Layer Super Output Area (LSOA) Code", all=TRUE)
names(merged_de)
merged_de$de_diff<-as.numeric(merged_de$de2019)-as.numeric(merged_de$de2010) 
summary(merged_de)
```

```{r Mapping the LSOA difference in mean dom elec consumption}
# merge to sf geometry on LSOA11CD
merged_de$LSOA11CD <- merged_de$"Lower Layer Super Output Area (LSOA) Code"
lsoa_sf_de20102019<-merge(lsoa_sf_data, merged_de)
ggplot2::ggplot(lsoa_sf_de20102019) +
  geom_sf(aes(fill=de_diff))+
  scale_fill_continuous(name="Change in Mean consumpton (kWh per meter)",low="green",high="red") +
  labs(caption="Solent(all LSOAs)")




lsoa_sf_de20102019$pc_diff <- 100*(lsoa_sf_de20102019$de_diff/lsoa_sf_de20102019$de2010)
t_diff <-  dplyr::select(as.data.frame(lsoa_sf_de20102019), 
                         LSOA11CD, `Lower Layer Super Output Area (LSOA) Name.y`,
                         de2010, de2019, de_diff, pc_diff)
head(arrange(t_diff, pc_diff))
head(arrange(t_diff, -pc_diff))
ggplot2::ggplot(t_diff, aes(x = pc_diff)) +
  geom_histogram()
```
#### Plotting the change in dom elec consumption against the deprivation score

Loading deprivation data and double checking what the IMD Decile means

```{r Loading in the Deprivation score data}
inFile<-paste0(dataFolder, "Indices of Multiple Deprivation/Indices_of_Multiple_Deprivation_(IMD)_2019.csv")
LSOAdep<-readr::read_csv(inFile)
LSOAdep$'LSOA11CD' <- LSOAdep$'lsoa11cd'
head(LSOAdep)
names(LSOAdep)

ggplot(Solent, aes(x = as.factor(IMD_Decile), # forces a box plot at each value 
                   y = IMDScore, 
                   group = IMD_Decile,
                   colour = IMD_Decile)) +  
  geom_boxplot() +
  scale_color_continuous(name = "IMD Decile") + # rename the legend scale
  labs(x = "IMD Decile",
       y = "IMD Score")
```

NB: IMD Decile 10 has _LOWER_ mean IMD score! Which is what it says in the Excel workbok...


```{r plotting change in elec usage against dep}
LSOAdepelec <- merge(merged_de, LSOAdep, by= "LSOA11CD")
names(LSOAdepelec)
df <- dplyr::select(LSOAdepelec, LSOA11CD, "Local Authority Name.x", "de_diff", IMDScore, de2010, IMD_Decile
)

head(df)
Solent <- dplyr::filter(df, `Local Authority Name.x` == "Basingstoke and Deane"|
                           `Local Authority Name.x` == "East Hampshire"|
                           `Local Authority Name.x` == "Eastleigh"|
                           `Local Authority Name.x` == "Fareham"|
                           `Local Authority Name.x` == "Gosport"|
                           `Local Authority Name.x` == "Hart"|
                           `Local Authority Name.x` == "Havant"|
                           `Local Authority Name.x` == "New Forest"|
                           `Local Authority Name.x` == "Portsmouth"|
                           `Local Authority Name.x` == "Rushmoor"|
                           `Local Authority Name.x` == "Southampton"|
                           `Local Authority Name.x` == "Test Valley"|
                           `Local Authority Name.x` == "Winchester"|
                           `Local Authority Name.x` == "Isle of Wight"
                           )
head(Solent)
ggplot(Solent, aes(x = as.factor(IMD_Decile), # forces a box plot at each value 
                   y =100*(de_diff/de2010), 
                   group = IMD_Decile,
                   colour = IMD_Decile)) +  
  geom_boxplot() +
  scale_color_continuous(name = "IMD Decile") + # rename the legend scale
  labs(x = "IMD Decile",
       y = "% change")
```

Try adding facets for each Local Authority

```{r addFacetsToElecDiff}
# or without colour but using facets for Local Authorities
ggplot(Solent, aes(x = as.factor(IMD_Decile), # forces a box plot at each value 
                   y =100*(de_diff/de2010), 
                   group = IMD_Decile)) +
  geom_boxplot() +
  labs(x = "IMD Decile",
       y = "% change") +
  facet_wrap(`Local Authority Name.x` ~ .)

nrow(Solent)
```
####Map with Overlay 
```{r Check leaflet for Change in dom elec consumption}
library(leaflet)

st_coord_sys <- st_crs(lsoa_sf_de20102019)
st_coord_sys$epsg

#Transforming the coord system
if(st_coord_sys$epsg !=4326) {
  map_df_trans <- st_transform(lsoa_sf_de20102019, "+proj=longlat +datum=WGS84")
}

```
```{r Plotting leaflet for change in dom elec consumption map}
qpal <- colorNumeric("Reds", map_df_trans$de_diff, n=9)

leaflet(map_df_trans) %>% 
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addPolygons(color = ~qpal(de_diff),
              fillOpacity = 0.6, weight = 1.5, popup = ~(LSOA11CD ), 
             
  
               highlight = highlightOptions(
                weight = 5,
                color = "#666",
                fillOpacity = 0.7,
                bringToFront = TRUE))

```

#####Cities in more detail
```{r Southampton LSOA difference in dom Elec}
#Cities such as Southampton disappear due to their density, we will now map Southampton alone to see this area in more detail
mapData <- dplyr::filter(lsoa_sf_de20102019, LAD11NM == "Southampton")
# plotting the electricity consumption of Southampton in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill= de_diff)) +
  scale_fill_continuous(name = "Change in Mean consumpton (kWh per meter)", low = "green", high = "red") +
  labs(caption = "Southampton")
#BROKEN
```
```{r Portsmouth LSOA difference in dom Elec}
#Cities such as Portsmouth disappear due to their density, we will now map Portsmouth alone to see this area in more detail
mapData <- dplyr::filter(lsoa_sf_de20102019, LAD11NM == "Portsmouth")
# plotting the electricity consumption of Portsmouth in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = de_diff)) +
  scale_fill_continuous(name = "Change in Mean comsumpton (kWh per meter)", low = "green", high = "red") +
  labs(caption = "Portsmouth")
```
```{r Winchester LSOA difference in dom Elec}
#Cities such as Winchester disappear due to their density, we will now map Winchester alone to see this area in more detail
mapData <- dplyr::filter(lsoa_sf_de20102019, LAD11NM == "Winchester")
# plotting the electricity consumption of Winchester in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = de_diff)) +
  scale_fill_continuous(name = "Change in Mean comsumpton (kWh per meter)", low = "green", high = "red") +
  labs(caption = "Winchester")
```

### Mapping Gas
####2019
```{r Loading in the LSOA gas consumption data}
#Electricty consumption data LSOA pre downloaded
inFile <-paste0(dataFolder, "energy/gas/LSOA Gas csv/LSOA_GAS_2019.csv")
lsoa_gasData <- readr::read_csv(inFile)
lsoa_gasData$LSOA11CD <- lsoa_gasData$`Lower Layer Super Output Area (LSOA) Code`
head(lsoa_gasData)
```

```{r Mapping the gas consumption of the LSOAs}
lsoa_merged_sf_gas <- merge(lsoa_sf_data, lsoa_gasData) #merging the boundaries and energy data
ggplot2::ggplot(lsoa_merged_sf_gas) + 
  geom_sf(aes(fill = `Mean consumption (kWh per meter)`)) +
  scale_fill_continuous(name = "Gas: Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Solent (all LSOAs)")
#Mapping it
```
> Aha - this one shows where there is no gas :-)

###Map with Overlay
```{r Check leaflet for dom gas consumption}
library(leaflet)

st_coord_sys <- st_crs(lsoa_merged_sf_gas)
st_coord_sys$epsg 

#Transforming the coord system
if(st_coord_sys$epsg !=4326){
  map_df_trans <- st_transform(lsoa_merged_sf_gas, "+proj=longlat +datum=WGS84")
}
```
```{r Plotting leaflet dom gas consumption}
qpal <- colorNumeric("Reds", map_df_trans$`Mean consumption (kWh per meter)`, n=9)

leaflet(map_df_trans) %>%
  addTiles() %>%
  addPolygons(color= ~qpal(`Mean consumption (kWh per meter)`), 
              fillOpacity = 0.6, weight = 1.5, popup = ~(LSOA11CD),
              
              highlight=highlightOptions(
                weight=5,
                color="#666",
                fillOpacity = 0.7,
                bringToFront = TRUE))
  

```


#####Cities in More detail
```{r Southampton LSOA Gas}
#Cities such as Southampton disappear due to their density, we will now map Southampton alone to see this area in more detail
mapData <- dplyr::filter(lsoa_merged_sf_gas, LAD11NM == "Southampton")

# plotting the gas consumption of Southampton in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = `Mean consumption (kWh per meter)`)) +
  scale_fill_continuous(name = "Gas: Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Southampton")
```
```{r Portsmouth LSOA Gas}
#Cities such as Portsmouth disappear due to their density, we will now map Portsmouth alone to see this area in more detail
mapData <- dplyr::filter(lsoa_merged_sf_gas, LAD11NM == "Portsmouth")

# plotting the gas consumption of Portsmouth in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = `Mean consumption (kWh per meter)`)) +
  scale_fill_continuous(name = "Gas: Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Portsmouth")
```
```{r Winchester LSOA Gas}
#Cities such as Winchester disappear due to their density, we will now map Winchester alone to see this area in more detail
mapData <- dplyr::filter(lsoa_merged_sf_gas, LAD11NM == "Winchester")

# plotting the gas consumption of Winchester in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = `Mean consumption (kWh per meter)`)) +
  scale_fill_continuous(name = "Gas: Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Winchester")
```
####Difference between 2010 and 2019 dom gas 
```{r Creating the dfference in LSOA dom gas consumption variable}
#Green indicates a decrease in gas consumption from 2010 to 2019
#Red indicates an increase in gas consumption from 2010 to 2019
dgas_LSOA_2010 <- readr::read_csv(paste0(dataFolder, "energy/gas/LSOA Gas csv/LSOA_GAS_2010.csv"))
dgas_LSOA_2019 <- readr::read_csv(paste0(dataFolder, "energy/gas/LSOA Gas csv/LSOA_GAS_2019.csv"))

dgas_LSOA_2010$dgas2010 <- dgas_LSOA_2010$'Mean consumption (kWh per meter)'
dgas_LSOA_2019$dgas2019 <- dgas_LSOA_2019$'Mean consumption (kWh per meter)'
merged_dgas <- merge(dgas_LSOA_2010, dgas_LSOA_2019, by = "Lower Layer Super Output Area (LSOA) Code", all = TRUE)
names(merged_dgas)
merged_dgas$dg_diff<-as.numeric(merged_dgas$dgas2019) - merged_dgas$dgas2010
summary(merged_dgas)
```

```{r Mapping the change in LSOA dom mean gas comsumption}
merged_dgas$LSOA11CD <- merged_dgas$"Lower Layer Super Output Area (LSOA) Code" #creating a variable with the LSOA code in the same name as in sf_data
lsoa_dgas20102019 <- merge(lsoa_sf_data, merged_dgas) #merging these
ggplot2::ggplot(lsoa_dgas20102019) + geom_sf(aes(fill=dg_diff))+ 
                  scale_fill_continuous(name="Change in Gas: Mean kWh per meter", low="green",high="red")+
  labs(caption ="Solent (all MSOAs)") ##BROKEN
##Need to change the varibale names to reflect what is actually there
```
####Map with overlay 
```{r Check leaflet for change i dom gas consumption}
library(leaflet)

st_coord_sys <- st_crs(lsoa_dgas20102019)
st_coord_sys$epsg

#Transforming the coor system
if(st_coord_sys$epsg !=4326){
  map_df_trans <- st_transform(lsoa_dgas20102019, "+proj=longlat +datum=WGS84")
}

```
```{r Plotting leaflet for change in dom gas consumption map}
qpal <- colorNumeric("Reds", map_df_trans$dg_diff, n=9)

leaflet(map_df_trans) %>%
  addTiles() %>%
  addPolygons(color = ~qpal(dg_diff),
              fillOpacity = 0.6, weight = 1.5, popup = ~(LSOA11CD), 
             
  
               highlight = highlightOptions(
                weight = 5,
                color = "#666",
                fillOpacity = 0.7,
                bringToFront = TRUE))

```
#####Cities in more detail
```{r Southampton change in LSOA Gas}
#Cities such as Southampton disappear due to their density, we will now map Southampton alone to see this area in more detail
mapData <- dplyr::filter(lsoa_dgas20102019, LAD11NM == "Southampton")

# plotting the gas consumption of Southampton in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = dg_diff)) +
  scale_fill_continuous(name = "Gas: Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Southampton")
```
```{r Portsmouth Change in LSOA Gas}
#Cities such as Portsmouth disappear due to their density, we will now map Portsmouth alone to see this area in more detail
mapData <- dplyr::filter(lsoa_dgas20102019, LAD11NM == "Portsmouth")

# plotting the gas consumption of Portsmouth in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = dg_diff)) +
  scale_fill_continuous(name = "Gas: Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Portsmouth")
```
```{r Winchester Chnage in LSOA Gas}
#Cities such as Winchester disappear due to their density, we will now map Winchester alone to see this area in more detail
mapData <- dplyr::filter(lsoa_dgas20102019, LAD11NM == "Winchester")

# plotting the gas consumption of Winchester in more detail
ggplot2::ggplot(mapData) + 
  geom_sf(aes(fill = dg_diff)) +
  scale_fill_continuous(name = "Gas: Mean kWh per meter", low = "green", high = "red") +
  labs(caption = "Winchester")
```

